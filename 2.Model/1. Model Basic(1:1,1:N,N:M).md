# 🎓 Django Relationships - Complete Guide

## 📊 ASCII Relationship Diagrams

```
════════════════════════════════════════════════════════════════
                    RELATIONSHIP OVERVIEW
════════════════════════════════════════════════════════════════

1️⃣ ONE-TO-ONE (1:1)
   Student ←──────→ StudentProfile
   (One student has exactly one profile)

2️⃣ ONE-TO-MANY (1:N)
   Teacher ←──────→ Course
           │        ├─ Course 1
           │        ├─ Course 2
           └────────└─ Course 3
   (One teacher teaches many courses)

3️⃣ MANY-TO-MANY (N:M)
   Student ←──────→ Course
   │                │
   ├─ Student 1 ───→├─ Course A
   ├─ Student 2 ───→├─ Course B
   └─ Student 3 ───→└─ Course C
   (Many students can enroll in many courses)
```

---

## 🗂️ Complete Example: Student Management System

### **Detailed ASCII Diagram**

```
┌─────────────────────────────────────────────────────────────┐
│                   DATABASE RELATIONSHIPS                     │
└─────────────────────────────────────────────────────────────┘

        ┌──────────────┐
        │   Teacher    │
        │──────────────│
        │ id (PK)      │
        │ name         │
        │ email        │
        └──────┬───────┘
               │
               │ 1:N (One teacher → Many courses)
               │
               ↓
        ┌──────────────┐         ┌─────────────────┐
        │    Course    │←────────│   Enrollment    │
        │──────────────│   N:M   │─────────────────│
        │ id (PK)      │         │ id (PK)         │
        │ name         │         │ student_id (FK) │
        │ teacher (FK) │         │ course_id (FK)  │
        │ credits      │         │ enrolled_date   │
        └──────────────┘         │ grade           │
               ↑                 └────────┬────────┘
               │                          │
               │                          │
               │ N:M                      │
               │ (Many students ←→ Many courses)
               │                          │
        ┌──────┴───────┐                 │
        │   Student    │←────────────────┘
        │──────────────│
        │ id (PK)      │
        │ name         │
        │ email        │
        └──────┬───────┘
               │
               │ 1:1 (One student → One profile)
               │
               ↓
        ┌──────────────┐
        │StudentProfile│
        │──────────────│
        │ id (PK)      │
        │ student (FK) │ ← OneToOneField
        │ phone        │
        │ address      │
        │ date_of_birth│
        └──────────────┘
```

---

## 📝 Models Code

### **models.py**

```python
from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator


# ═══════════════════════════════════════════════════════
# 👨‍🏫 TEACHER MODEL (Parent in 1:N relationship)
# ═══════════════════════════════════════════════════════
class Teacher(models.Model):
    name = models.CharField(max_length=100)
    email = models.EmailField(unique=True)
    department = models.CharField(max_length=100)
    
    def __str__(self):
        return self.name
    
    class Meta:
        db_table = 'teachers'


# ═══════════════════════════════════════════════════════
# 👨‍🎓 STUDENT MODEL (Main entity)
# ═══════════════════════════════════════════════════════
class Student(models.Model):
    name = models.CharField(max_length=100)
    email = models.EmailField(unique=True)
    enrollment_date = models.DateField(auto_now_add=True)
    
    def __str__(self):
        return self.name
    
    class Meta:
        db_table = 'students'


# ═══════════════════════════════════════════════════════
# 📋 STUDENT PROFILE MODEL (1:1 with Student)
# ═══════════════════════════════════════════════════════
class StudentProfile(models.Model):
    # 🔗 ONE-TO-ONE RELATIONSHIP
    student = models.OneToOneField(
        Student,
        on_delete=models.CASCADE,
        related_name='profile'  # Access: student.profile
    )
    
    phone = models.CharField(max_length=15)
    address = models.TextField()
    date_of_birth = models.DateField()
    emergency_contact = models.CharField(max_length=15)
    
    def __str__(self):
        return f"Profile of {self.student.name}"
    
    class Meta:
        db_table = 'student_profiles'


# ═══════════════════════════════════════════════════════
# 📚 COURSE MODEL (Child in 1:N, Parent in N:M)
# ═══════════════════════════════════════════════════════
class Course(models.Model):
    name = models.CharField(max_length=100)
    code = models.CharField(max_length=10, unique=True)
    credits = models.IntegerField(validators=[MinValueValidator(1)])
    
    # 🔗 ONE-TO-MANY RELATIONSHIP (Many courses → One teacher)
    teacher = models.ForeignKey(
        Teacher,
        on_delete=models.SET_NULL,
        null=True,
        related_name='courses'  # Access: teacher.courses.all()
    )
    
    # 🔗 MANY-TO-MANY RELATIONSHIP (via Enrollment)
    students = models.ManyToManyField(
        Student,
        through='Enrollment',  # Custom intermediate table
        related_name='courses'  # Access: student.courses.all()
    )
    
    def __str__(self):
        return f"{self.code} - {self.name}"
    
    class Meta:
        db_table = 'courses'


# ═══════════════════════════════════════════════════════
# 📝 ENROLLMENT MODEL (N:M Intermediate/Junction Table)
# ═══════════════════════════════════════════════════════
class Enrollment(models.Model):
    GRADE_CHOICES = [
        ('A+', 'A+'), ('A', 'A'), ('A-', 'A-'),
        ('B+', 'B+'), ('B', 'B'), ('B-', 'B-'),
        ('C+', 'C+'), ('C', 'C'), ('C-', 'C-'),
        ('D', 'D'), ('F', 'F'), ('I', 'Incomplete'),
    ]
    
    # 🔗 MANY-TO-MANY RELATIONSHIPS
    student = models.ForeignKey(
        Student,
        on_delete=models.CASCADE,
        related_name='enrollments'
    )
    
    course = models.ForeignKey(
        Course,
        on_delete=models.CASCADE,
        related_name='enrollments'
    )
    
    # Extra fields in junction table
    enrolled_date = models.DateField(auto_now_add=True)
    grade = models.CharField(max_length=2, choices=GRADE_CHOICES, null=True, blank=True)
    attendance_percentage = models.DecimalField(
        max_digits=5, 
        decimal_places=2, 
        validators=[MinValueValidator(0), MaxValueValidator(100)],
        null=True,
        blank=True
    )
    
    def __str__(self):
        return f"{self.student.name} → {self.course.code}"
    
    class Meta:
        db_table = 'enrollments'
        unique_together = ['student', 'course']  # Prevent duplicate enrollments
```

---

## 🔍 Relationship Details

### **1️⃣ ONE-TO-ONE (1:1)**

```python
# Definition
class StudentProfile(models.Model):
    student = models.OneToOneField(
        Student,
        on_delete=models.CASCADE,
        related_name='profile'
    )
```

**ASCII Flow:**
```
Student (id=1) ←────────→ StudentProfile (id=1, student_id=1)
   John Doe                 Phone: 123-456
                           Address: 123 Main St
```

**Usage:**
```python
# Create
student = Student.objects.create(name="John Doe", email="john@example.com")
profile = StudentProfile.objects.create(
    student=student,
    phone="123-456-7890",
    address="123 Main St",
    date_of_birth="2000-01-01"
)

# Access (Forward)
profile = student.profile  # Get profile from student

# Access (Backward)
student = profile.student  # Get student from profile
```

---

### **2️⃣ ONE-TO-MANY (1:N)**

```python
# Definition
class Course(models.Model):
    teacher = models.ForeignKey(
        Teacher,
        on_delete=models.SET_NULL,
        null=True,
        related_name='courses'
    )
```

**ASCII Flow:**
```
Teacher (id=1)
  Dr. Smith
     │
     ├──→ Course (id=1, teacher_id=1) "Python 101"
     ├──→ Course (id=2, teacher_id=1) "Django Advanced"
     └──→ Course (id=3, teacher_id=1) "Web Development"
```

**Usage:**
```python
# Create
teacher = Teacher.objects.create(
    name="Dr. Smith",
    email="smith@uni.edu",
    department="Computer Science"
)

course1 = Course.objects.create(
    name="Python 101",
    code="CS101",
    credits=3,
    teacher=teacher
)

course2 = Course.objects.create(
    name="Django Advanced",
    code="CS201",
    credits=4,
    teacher=teacher
)

# Access (Forward: Course → Teacher)
teacher_of_course = course1.teacher

# Access (Backward: Teacher → All Courses)
all_courses = teacher.courses.all()
```

---

### **3️⃣ MANY-TO-MANY (N:M)**

```python
# Definition
class Course(models.Model):
    students = models.ManyToManyField(
        Student,
        through='Enrollment',
        related_name='courses'
    )

class Enrollment(models.Model):
    student = models.ForeignKey(Student, ...)
    course = models.ForeignKey(Course, ...)
    grade = models.CharField(...)
```

**ASCII Flow:**
```
Students              Enrollments              Courses
────────              ───────────              ───────
John (id=1) ─────→ (student_id=1, course_id=1) ←───→ Python 101 (id=1)
            ─────→ (student_id=1, course_id=2) ←───→ Django (id=2)
            
Alice (id=2) ────→ (student_id=2, course_id=1) ←───→ Python 101 (id=1)
             ────→ (student_id=2, course_id=3) ←───→ Web Dev (id=3)

Bob (id=3) ──────→ (student_id=3, course_id=2) ←───→ Django (id=2)
           ──────→ (student_id=3, course_id=3) ←───→ Web Dev (id=3)
```

**Usage:**
```python
# Create Students
john = Student.objects.create(name="John Doe", email="john@example.com")
alice = Student.objects.create(name="Alice Smith", email="alice@example.com")

# Create Courses
python_course = Course.objects.create(name="Python 101", code="CS101", credits=3)
django_course = Course.objects.create(name="Django", code="CS201", credits=4)

# Enroll students (creates Enrollment records)
Enrollment.objects.create(
    student=john,
    course=python_course,
    grade='A'
)

Enrollment.objects.create(
    student=john,
    course=django_course,
    grade='B+'
)

Enrollment.objects.create(
    student=alice,
    course=python_course,
    grade='A+'
)

# Access (Forward: Student → Courses)
johns_courses = john.courses.all()

# Access (Backward: Course → Students)
python_students = python_course.students.all()

# Access through intermediate table
johns_enrollments = john.enrollments.all()
for enrollment in johns_enrollments:
    print(f"{enrollment.course.name}: {enrollment.grade}")
```

---

## 📊 Complete Relationship Summary

```
╔═══════════════════════════════════════════════════════════════╗
║                   RELATIONSHIP TYPES                          ║
╚═══════════════════════════════════════════════════════════════╝

┌─────────────┬──────────────────┬─────────────────────────────┐
│ Relationship│ Django Field     │ Example                     │
├─────────────┼──────────────────┼─────────────────────────────┤
│ 1:1         │ OneToOneField    │ Student ↔ StudentProfile    │
│ 1:N         │ ForeignKey       │ Teacher → Course            │
│ N:M         │ ManyToManyField  │ Student ↔ Course            │
└─────────────┴──────────────────┴─────────────────────────────┘
```

---

## 🎯 Query Examples

### **Example 1: Get all courses taught by a teacher**
```python
teacher = Teacher.objects.get(id=1)
courses = teacher.courses.all()

# With prefetch for optimization
teacher = Teacher.objects.prefetch_related('courses').get(id=1)
```

### **Example 2: Get student's profile**
```python
student = Student.objects.get(id=1)
profile = student.profile  # 1:1 access

# Or with select_related (optimization)
student = Student.objects.select_related('profile').get(id=1)
```

### **Example 3: Get all students in a course**
```python
course = Course.objects.get(code="CS101")
students = course.students.all()

# Get with grades (through Enrollment)
enrollments = course.enrollments.select_related('student').all()
for enrollment in enrollments:
    print(f"{enrollment.student.name}: {enrollment.grade}")
```

### **Example 4: Get all courses for a student**
```python
student = Student.objects.get(id=1)
courses = student.courses.all()

# With enrollment details
enrollments = student.enrollments.select_related('course').all()
for enrollment in enrollments:
    print(f"{enrollment.course.name}: Grade {enrollment.grade}")
```

### **Example 5: Complex query - Students in courses taught by specific teacher**
```python
teacher = Teacher.objects.get(name="Dr. Smith")
students = Student.objects.filter(
    courses__teacher=teacher
).distinct()
```

---

## 🗃️ Admin Registration

```python
# admin.py
from django.contrib import admin
from .models import Teacher, Student, StudentProfile, Course, Enrollment


@admin.register(Teacher)
class TeacherAdmin(admin.ModelAdmin):
    list_display = ['name', 'email', 'department']


@admin.register(Student)
class StudentAdmin(admin.ModelAdmin):
    list_display = ['name', 'email', 'enrollment_date']


@admin.register(StudentProfile)
class StudentProfileAdmin(admin.ModelAdmin):
    list_display = ['student', 'phone', 'date_of_birth']


@admin.register(Course)
class CourseAdmin(admin.ModelAdmin):
    list_display = ['code', 'name', 'credits', 'teacher']
    list_filter = ['teacher']


@admin.register(Enrollment)
class EnrollmentAdmin(admin.ModelAdmin):
    list_display = ['student', 'course', 'grade', 'enrolled_date']
    list_filter = ['course', 'grade']
```

---

## 🚀 Database Migrations

```bash
# Create migrations
python manage.py makemigrations

# Apply migrations
python manage.py migrate

# Create superuser
python manage.py createsuperuser
```

---

## ✅ Key Takeaways

| Relationship | Field | On Model | Access Pattern |
|--------------|-------|----------|----------------|
| **1:1** | `OneToOneField` | Either side | `student.profile` or `profile.student` |
| **1:N** | `ForeignKey` | "Many" side | `course.teacher` (forward)<br>`teacher.courses.all()` (reverse) |
| **N:M** | `ManyToManyField` | Either side | `student.courses.all()`<br>`course.students.all()` |

---

**Perfect! Now you understand all Django relationships! 🎉**
