# 🔄 Laravel to Django ORM Conversion Guide

Complete conversion from Laravel Eloquent to Django ORM with examples and comparisons.

---

## 📊 Quick Reference Table

| Laravel Eloquent | Django ORM | Relationship Type |
|-----------------|------------|-------------------|
| `hasOne()` | `OneToOneField()` | 1:1 |
| `belongsTo()` | `ForeignKey()` | Reverse 1:1 or N:1 |
| `hasMany()` | `ForeignKey()` (reverse) | 1:N |
| `belongsToMany()` | `ManyToManyField()` | N:M |
| `hasManyThrough()` | Complex query or custom manager | Through relationship |
| `morphTo()` / `morphMany()` | `GenericForeignKey()` / `GenericRelation()` | Polymorphic |
| `morphToMany()` | `GenericForeignKey()` + `ManyToManyField()` | Polymorphic N:M |

---

## 1️⃣ One-to-One (1:1)

### **Laravel Code**

```php
// User Model
public function address() {
    return $this->hasOne(Address::class, 'user_id', 'id');
}

// Address Model
public function user() {
    return $this->belongsTo(User::class, 'user_id', 'id');
}
```

### **Django Equivalent**

```python
# models.py
from django.db import models

# User Model (built-in or custom)
class User(models.Model):
    name = models.CharField(max_length=100)
    email = models.EmailField(unique=True)
    
    def __str__(self):
        return self.name

# Address Model
class Address(models.Model):
    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name='address',  # Access: user.address
        primary_key=False
    )
    country = models.CharField(max_length=100)
    city = models.CharField(max_length=100)
    
    def __str__(self):
        return f"{self.user.name}'s address"
```

### **Creating Records**

**Laravel:**
```php
$user = User::factory()->create();
$address = new Address(['country' => 'Malaysia']);
$address->user()->associate($user);
$address->save();

// Or
$user->address()->create(['country' => 'Bangladesh']);
```

**Django:**
```python
# Create user
user = User.objects.create(name="John", email="john@example.com")

# Create address
address = Address.objects.create(
    user=user,
    country='Malaysia',
    city='Kuala Lumpur'
)

# Or using reverse relation
user.address = Address(country='Bangladesh', city='Dhaka')
user.address.save()
```

### **Accessing Relations**

**Laravel:**
```php
$address = $user->address;
$user = $address->user;
```

**Django:**
```python
# Forward access
address = user.address

# Backward access
user = address.user
```

### **Handling Null Relationships**

**Laravel:**
```php
public function user() {
    return $this->belongsTo(User::class)->withDefault([
        'name' => 'Guest User',
    ]);
}
```

**Django:**
```python
# In the view or wherever you access it
try:
    address = user.address
except Address.DoesNotExist:
    address = None  # Or create default

# Or check existence
if hasattr(user, 'address'):
    address = user.address
else:
    address = None
```

---

## 2️⃣ One-to-Many (1:N)

### **Laravel Code**

```php
// User Model
public function posts() {
    return $this->hasMany(Post::class, 'user_id', 'id');
}

// Post Model
public function user() {
    return $this->belongsTo(User::class, 'user_id');
}
```

### **Django Equivalent**

```python
# models.py

class User(models.Model):
    name = models.CharField(max_length=100)
    email = models.EmailField(unique=True)
    
    def __str__(self):
        return self.name

class Post(models.Model):
    user = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='posts'  # Access: user.posts.all()
    )
    title = models.CharField(max_length=200)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return self.title
```

### **Creating Records**

**Laravel:**
```php
$user = User::find(1);
$user->posts()->create([
    'title' => 'New Post Title',
    'content' => 'Post content...'
]);
```

**Django:**
```python
user = User.objects.get(id=1)
user.posts.create(
    title='New Post Title',
    content='Post content...'
)

# Or
post = Post.objects.create(
    user=user,
    title='New Post Title',
    content='Post content...'
)
```

### **Retrieving Records**

**Laravel:**
```php
$posts = User::find(1)->posts;
$postTitles = $user->posts->pluck('title')->toArray();
```

**Django:**
```python
# Get all posts
posts = User.objects.get(id=1).posts.all()

# Get list of titles
post_titles = user.posts.values_list('title', flat=True)
# Or
post_titles = [post.title for post in user.posts.all()]
```

---

## 3️⃣ Many-to-Many (N:M)

### **Laravel Code**

```php
// Post Model
public function tags() {
    return $this->belongsToMany(Tag::class, 'post_tag', 'post_id', 'tag_id');
}

// Tag Model
public function posts() {
    return $this->belongsToMany(Post::class, 'post_tag', 'tag_id', 'post_id');
}
```

### **Django Equivalent**

```python
# models.py

class Tag(models.Model):
    name = models.CharField(max_length=50, unique=True)
    
    def __str__(self):
        return self.name

class Post(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='posts')
    title = models.CharField(max_length=200)
    content = models.TextField()
    tags = models.ManyToManyField(
        Tag,
        related_name='posts',  # Access: tag.posts.all()
        db_table='post_tag'    # Optional: custom table name
    )
    
    def __str__(self):
        return self.title
```

**ASCII Diagram:**
```
┌──────────┐    ┌──────────────┐    ┌───────────┐
│   Post   │    │   post_tag   │    │    Tag    │
├──────────┤    ├──────────────┤    ├───────────┤
│ id       │◄───┤ post_id      │───►│ id        │
│ title    │    │ tag_id       │    │ name      │
└──────────┘    └──────────────┘    └───────────┘
```

### **Working with Many-to-Many**

**Laravel:**
```php
$post = Post::find(1);

// Attach
$post->tags()->attach([1, 2, 3]);

// Detach
$post->tags()->detach([2]);
$post->tags()->detach();  // All

// Sync
$post->tags()->sync([1, 3, 4]);
```

**Django:**
```python
post = Post.objects.get(id=1)

# Add tags
post.tags.add(1, 2, 3)
# Or with objects
tag1 = Tag.objects.get(id=1)
post.tags.add(tag1)

# Remove tags
post.tags.remove(2)
# Or
post.tags.clear()  # Remove all

# Set (similar to sync)
post.tags.set([1, 3, 4])
```

---

## 4️⃣ Many-to-Many with Pivot/Through Table

### **Laravel Code**

```php
// Migration
Schema::create('post_tag', function (Blueprint $table) {
    $table->bigInteger('post_id');
    $table->bigInteger('tag_id');
    $table->string('status')->nullable();
    $table->timestamps();
});

// Post Model
public function tags() {
    return $this->belongsToMany(Tag::class)
                ->withPivot('status')
                ->withTimestamps();
}
```

### **Django Equivalent**

```python
# models.py

class PostTag(models.Model):
    """Custom through model for Post-Tag relationship"""
    post = models.ForeignKey(Post, on_delete=models.CASCADE)
    tag = models.ForeignKey(Tag, on_delete=models.CASCADE)
    status = models.CharField(max_length=50, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'post_tag'
        unique_together = ['post', 'tag']  # Prevent duplicates
    
    def __str__(self):
        return f"{self.post.title} - {self.tag.name}"

class Post(models.Model):
    title = models.CharField(max_length=200)
    content = models.TextField()
    tags = models.ManyToManyField(
        Tag,
        through='PostTag',  # Use custom through model
        related_name='posts'
    )
```

### **Working with Through Table**

**Laravel:**
```php
// Setting values when attaching
$post->tags()->attach([1 => ['status' => 'approved']]);

// Accessing pivot data
foreach ($post->tags as $tag) {
    echo $tag->pivot->status;
}
```

**Django:**
```python
# Create with additional fields
PostTag.objects.create(
    post=post,
    tag=tag,
    status='approved'
)

# Accessing through data
for tag in post.tags.all():
    post_tag = PostTag.objects.get(post=post, tag=tag)
    print(post_tag.status)

# Better way with prefetch
post = Post.objects.prefetch_related('posttag_set').get(id=1)
for post_tag in post.posttag_set.all():
    print(f"{post_tag.tag.name}: {post_tag.status}")
```

---

## 5️⃣ Has-Many-Through

### **Laravel Code**

```php
// Project Model
public function tasks() {
    return $this->hasManyThrough(
        Task::class,
        User::class,
        'project_id',
        'user_id',
        'id',
        'id'
    );
}
```

**Diagram:**
```
┌──────────┐     ┌──────────┐     ┌───────────┐
│  Project │     │   User   │     │   Task    │
├──────────┤     ├──────────┤     ├───────────┤
│ id       │────►│ project_id    │     user_id│◄───┐
│ title    │  1:N│ name     │  1:N│ title     │    │
└──────────┘     └──────────┘     └───────────┘    │
      │                                             │
      └─────────────────────────────────────────────┘
```

### **Django Equivalent**

Django doesn't have a direct `hasManyThrough`, but you can achieve it with queries:

```python
# models.py

class Project(models.Model):
    title = models.CharField(max_length=200)
    
    def get_tasks(self):
        """Get all tasks through users"""
        return Task.objects.filter(user__project=self)
    
    def __str__(self):
        return self.title

class User(models.Model):
    name = models.CharField(max_length=100)
    project = models.ForeignKey(
        Project,
        on_delete=models.CASCADE,
        related_name='users'
    )

class Task(models.Model):
    title = models.CharField(max_length=200)
    user = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='tasks'
    )
```

### **Usage**

**Laravel:**
```php
$project = Project::find(1);
$tasks = $project->tasks;
```

**Django:**
```python
project = Project.objects.get(id=1)

# Method 1: Custom method
tasks = project.get_tasks()

# Method 2: Direct query
tasks = Task.objects.filter(user__project=project)

# Method 3: Through users
tasks = []
for user in project.users.all():
    tasks.extend(user.tasks.all())
```

---

## 6️⃣ Polymorphic Relationships (Generic Relations)

### **Laravel Code**

```php
// Comment Migration
Schema::create('comments', function (Blueprint $table) {
    $table->id();
    $table->bigInteger('user_id');
    $table->text('body');
    $table->morphs('commentable');  // commentable_id & commentable_type
    $table->timestamps();
});

// Comment Model
public function commentable() {
    return $this->morphTo();
}

// Post Model
public function comments() {
    return $this->morphMany(Comment::class, 'commentable');
}

// Video Model
public function comments() {
    return $this->morphMany(Comment::class, 'commentable');
}
```

### **Django Equivalent**

```python
# models.py
from django.contrib.contenttypes.fields import GenericForeignKey, GenericRelation
from django.contrib.contenttypes.models import ContentType

class Comment(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    body = models.TextField()
    
    # Polymorphic fields
    content_type = models.ForeignKey(ContentType, on_delete=models.CASCADE)
    object_id = models.PositiveIntegerField()
    commentable = GenericForeignKey('content_type', 'object_id')
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return f"Comment by {self.user.name}"

class Post(models.Model):
    title = models.CharField(max_length=200)
    content = models.TextField()
    
    # Reverse generic relation
    comments = GenericRelation(Comment)
    
    def __str__(self):
        return self.title

class Video(models.Model):
    title = models.CharField(max_length=200)
    url = models.URLField()
    
    # Reverse generic relation
    comments = GenericRelation(Comment)
    
    def __str__(self):
        return self.title
```

**Diagram:**
```
          ┌───────────────┐
          │    Comment    │
          ├───────────────┤
          │ id            │
          │ user_id       │
          │ body          │
          │ content_type_id   │  (Model type)
          │ object_id     │  (Post/Video ID)
          └───────────────┘
             ▲     ▲
             │     │
 ┌───────────┘     └───────────┐
 │                             │
┌┴──────────┐          ┌──────┴─────┐
│   Post    │          │   Video    │
├───────────┤          ├────────────┤
│ id        │          │ id         │
│ title     │          │ title      │
└───────────┘          └────────────┘
```

### **Usage**

**Laravel:**
```php
// Create
$post = Post::find(1);
$post->comments()->create([
    'user_id' => 1,
    'body' => 'Comment on post'
]);

$video = Video::find(1);
$video->comments()->create([
    'user_id' => 1,
    'body' => 'Comment on video'
]);

// Access
$comment = Comment::find(1);
$commentable = $comment->commentable;  // Post or Video
```

**Django:**
```python
from django.contrib.contenttypes.models import ContentType

# Create comment on post
post = Post.objects.get(id=1)
Comment.objects.create(
    user=user,
    body='Comment on post',
    commentable=post  # Automatically sets content_type and object_id
)

# Or using reverse relation
post.comments.create(
    user=user,
    body='Comment on post'
)

# Create comment on video
video = Video.objects.get(id=1)
video.comments.create(
    user=user,
    body='Comment on video'
)

# Access parent object
comment = Comment.objects.get(id=1)
commentable = comment.commentable  # Returns Post or Video instance

# Get all comments for a post
post_comments = post.comments.all()
```

### **Setup Required**

Add to `settings.py`:
```python
INSTALLED_APPS = [
    'django.contrib.contenttypes',  # Make sure this is included
    # ...
]
```

---

## 7️⃣ Many-to-Many Polymorphic

### **Laravel Code**

```php
// Taggables Migration
Schema::create('taggables', function (Blueprint $table) {
    $table->bigInteger('tag_id');
    $table->bigInteger('taggable_id');
    $table->string('taggable_type');
});

// Tag Model
public function posts() {
    return $this->morphedByMany(Post::class, 'taggable');
}
public function videos() {
    return $this->morphedByMany(Video::class, 'taggable');
}

// Post/Video Models
public function tags() {
    return $this->morphToMany(Tag::class, 'taggable');
}
```

### **Django Equivalent**

```python
# models.py
from django.contrib.contenttypes.fields import GenericForeignKey
from django.contrib.contenttypes.models import ContentType

class Tag(models.Model):
    name = models.CharField(max_length=50, unique=True)
    
    def __str__(self):
        return self.name
    
    def get_posts(self):
        """Get all posts with this tag"""
        post_ct = ContentType.objects.get_for_model(Post)
        taggable_ids = Taggable.objects.filter(
            tag=self,
            content_type=post_ct
        ).values_list('object_id', flat=True)
        return Post.objects.filter(id__in=taggable_ids)
    
    def get_videos(self):
        """Get all videos with this tag"""
        video_ct = ContentType.objects.get_for_model(Video)
        taggable_ids = Taggable.objects.filter(
            tag=self,
            content_type=video_ct
        ).values_list('object_id', flat=True)
        return Video.objects.filter(id__in=taggable_ids)

class Taggable(models.Model):
    """Junction table for polymorphic many-to-many"""
    tag = models.ForeignKey(Tag, on_delete=models.CASCADE)
    content_type = models.ForeignKey(ContentType, on_delete=models.CASCADE)
    object_id = models.PositiveIntegerField()
    content_object = GenericForeignKey('content_type', 'object_id')
    
    class Meta:
        unique_together = ['tag', 'content_type', 'object_id']
    
    def __str__(self):
        return f"{self.tag.name} on {self.content_type.model}"

class Post(models.Model):
    title = models.CharField(max_length=200)
    
    def get_tags(self):
        """Get all tags for this post"""
        post_ct = ContentType.objects.get_for_model(Post)
        tag_ids = Taggable.objects.filter(
            content_type=post_ct,
            object_id=self.id
        ).values_list('tag_id', flat=True)
        return Tag.objects.filter(id__in=tag_ids)
    
    def add_tag(self, tag):
        """Add a tag to this post"""
        Taggable.objects.get_or_create(
            tag=tag,
            content_type=ContentType.objects.get_for_model(Post),
            object_id=self.id
        )

class Video(models.Model):
    title = models.CharField(max_length=200)
    
    def get_tags(self):
        """Get all tags for this video"""
        video_ct = ContentType.objects.get_for_model(Video)
        tag_ids = Taggable.objects.filter(
            content_type=video_ct,
            object_id=self.id
        ).values_list('tag_id', flat=True)
        return Tag.objects.filter(id__in=tag_ids)
    
    def add_tag(self, tag):
        """Add a tag to this video"""
        Taggable.objects.get_or_create(
            tag=tag,
            content_type=ContentType.objects.get_for_model(Video),
            object_id=self.id
        )
```

### **Usage**

**Laravel:**
```php
$post = Post::find(1);
$post->tags()->create(['name' => 'Laravel']);

$tag = Tag::find(1);
$posts = $tag->posts;
$videos = $tag->videos;
```

**Django:**
```python
# Create and attach tag to post
post = Post.objects.get(id=1)
tag = Tag.objects.create(name='Django')
post.add_tag(tag)

# Or manually
Taggable.objects.create(
    tag=tag,
    content_object=post
)

# Get all tags for a post
tags = post.get_tags()

# Get all posts with a tag
tag = Tag.objects.get(name='Django')
posts = tag.get_posts()
videos = tag.get_videos()
```

---

## 8️⃣ Query Optimization

### **Eager Loading (N+1 Problem)**

**Laravel:**
```php
// Without eager loading
$posts = Post::all();
foreach ($posts as $post) {
    echo $post->user->name;  // N+1 queries
}

// With eager loading
$posts = Post::with('user')->get();
```

**Django:**
```python
# Without optimization
posts = Post.objects.all()
for post in posts:
    print(post.user.name)  # N+1 queries

# With select_related (for ForeignKey/OneToOne)
posts = Post.objects.select_related('user').all()
for post in posts:
    print(post.user.name)  # Single JOIN query

# With prefetch_related (for ManyToMany/Reverse FK)
posts = Post.objects.prefetch_related('tags').all()
for post in posts:
    for tag in post.tags.all():
        print(tag.name)

# Multiple relations
posts = Post.objects.select_related('user').prefetch_related('tags').all()
```

### **Query with Conditions**

**Laravel:**
```php
// Filter users who have posts
$users = User::has('posts')->get();

// Filter with conditions
$users = User::whereHas('posts', function ($query) {
    $query->where('title', 'like', '%Laravel%');
})->get();

// Users without posts
$users = User::doesntHave('posts')->get();
```

**Django:**
```python
# Users who have posts
users = User.objects.filter(posts__isnull=False).distinct()

# Users with specific post conditions
users = User.objects.filter(
    posts__title__icontains='Django'
).distinct()

# Users without posts
users = User.objects.filter(posts__isnull=True)

# Count posts
from django.db.models import Count
users = User.objects.annotate(
    post_count=Count('posts')
).filter(post_count__gte=2)
```

### **Selecting Specific Columns**

**Laravel:**
```php
$users = User::select('id', 'name')->get();

$posts = Post::select('id', 'title')
            ->with(['user' => function ($query) {
                $query->select('id', 'name');
            }])
            ->get();
```

**Django:**
```python
# Only specific fields
users = User.objects.only('id', 'name')

# Or values (returns dict)
users = User.objects.values('id', 'name')

# With relations
posts = Post.objects.select_related('user').only(
    'id', 'title', 'user__id', 'user__name'
)
```

---

## 9️⃣ Model Events

### **Laravel**

```php
protected static function boot() {
    parent::boot();
    
    static::created(function ($model) {
        // After create
    });
    
    static::updated(function ($model) {
        // After update
    });
}
```

### **Django**

```python
from django.db.models.signals import post_save, post_delete, pre_save
from django.dispatch import receiver

# Using signals
@receiver(post_save, sender=Post)
def post_created(sender, instance, created, **kwargs):
    if created:
        print(f"New post created: {instance.title}")

@receiver(pre_save, sender=Post)
def post_before_save(sender, instance, **kwargs):
    print(f"About to save: {instance.title}")

# Or override save method
class Post(models.Model):
    title = models.CharField(max_length=200)
    
    def save(self, *args, **kwargs):
        # Before save logic
        print(f"Saving post: {self.title}")
        super().save(*args, **kwargs)
        # After save logic
        print(f"Post saved!")
```

---

## 🔟 Complete Comparison Table

| Feature | Laravel | Django |
|---------|---------|--------|
| **1:1** | `hasOne()` / `belongsTo()` | `OneToOneField()` |
| **1:N** | `hasMany()` / `belongsTo()` | `ForeignKey()` with `related_name` |
| **N:M** | `belongsToMany()` | `ManyToManyField()` |
| **Through Table** | `withPivot()` | `through='Model'` |
| **Polymorphic** | `morphTo()` / `morphMany()` | `GenericForeignKey()` / `GenericRelation()` |
| **Eager Load** | `with()` | `select_related()` / `prefetch_related()` |
| **Create** | `create()` | `create()` |
| **Attach** | `attach()` | `add()` |
| **Detach** | `detach()` | `remove()` / `clear()` |
| **Sync** | `sync()` | `set()` |
| **Events** | `boot()` method | Signals or override `save()` |

---

## 📁 Complete Django Project Example

```python
# models.py
from django.db import models
from django.contrib.contenttypes.fields import GenericForeignKey, GenericRelation
from django.contrib.contenttypes.models import ContentType

class User(models.Model):
    name = models.CharField(max_length=100)
    email = models.EmailField(unique=True)

class Address(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='address')
    country = models.CharField(max_length=100)

class Post(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='posts')
    title = models.CharField(max_length=200)
    tags = models.ManyToManyField('Tag', through='PostTag', related_name='posts')
    comments = GenericRelation('Comment')

class Tag(models.Model):
    name = models.CharField(max_length=50, unique=True)

class PostTag(models.Model):
    post = models.ForeignKey(Post, on_delete=models.CASCADE)
    tag = models.ForeignKey(Tag, on_delete=models.CASCADE)
    status = models.CharField(max_length=50, null=True)
    created_at = models.DateTimeField(auto_now_add=True)

class Comment(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    body = models.TextField()
    content_type = models.ForeignKey(ContentType, on_delete=models.CASCADE)
    object_id = models.PositiveIntegerField()
    commentable = GenericForeignKey('content_type', 'object_id')
```

---

**✅ Complete! Now you can easily convert Laravel Eloquent to Django ORM!** 🎉
